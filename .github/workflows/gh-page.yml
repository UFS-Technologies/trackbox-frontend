name: Deploy to AWS S3 with WhatsApp Notifications

on:
  push:
    branches:
      - prod

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_ACCESS_KEY }}
        aws-region: ap-south-1
    
    - name: Install dependencies
      run: |
        npm ci
        npm install -g @angular/cli
    
    - name: Build Angular app
      run: ng build --configuration production
      env:
        CI: true
    
    - name: Deploy to S3
      if: success()
      run: |
        aws s3 sync ./dist/briffni-frontend/browser s3://breffni --delete
      env:
        AWS_MAX_ATTEMPTS: 5

    - name: Send WhatsApp Notification
      if: always()
      run: |
        TIMESTAMP=$(date '+%I:%M %p')
        
        # Create the notification payload
        cat << EOF > notification.json
        {
          "messaging_product": "whatsapp",
          "to": "919645685457",
          "type": "template",
          "template": {
            "name": "live__scheduled_2",
            "language": {
              "code": "en_US"
            },
            "components": [
              {
                "type": "body",
                "parameters": [
                  {
                    "type": "text",
                    "text": "Admin"
                  },
                  {
                    "type": "text",
                    "text": "Deployment Status: ${{ job.status }}"
                  },
                  {
                    "type": "text",
                    "text": "Breffni Frontend Deployment"
                  },
                  {
                    "type": "text",
                    "text": "Now"
                  }
                ]
              }
            ]
          }
        }
        EOF
        
        # Send the notification
        curl -X POST \
          https://graph.facebook.com/v20.0/392786753923720/messages \
          -H "Authorization: Bearer EAAG8HxaxDP4BOwbUBZCLFR92MEcM4yZCSYNsPDPBuPs6IpxGZCYtZAruKIfSuSoOTMFnZAJnhQ9gaNZCUgZCr6NX5siTtLnZBZAtMWSGAZA858wh4CzClMRDkMHj6bDgfGHJRzWPTThY0PE294UCZAe6gzm6X6WeHwFMW3aZBIAaVkK9uQkawKUZBQ5kepWbUfZCOXFCBZCwdWxm1bWTkmAIiiO" \
          -H "Content-Type: application/json" \
          -d @notification.json